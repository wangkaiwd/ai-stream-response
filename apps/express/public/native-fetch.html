<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>SSE demo</title>
  </head>
  <body>
    <button id="stop">stop</button>
    <button id="start">start</button>
    <pre id="log"></pre>
  </body>
  <script type="module">
    const stop = document.getElementById("stop");
    const start = document.getElementById("start");
    const controller = new AbortController();
    start.addEventListener("click", async () => {
      const response = await fetch("/chat", {
        signal: controller.signal,
        method: "POST",
      });
      const textDecoder = new TextDecoder();
      // response.body 是可读流
      for await (const chunk of response.body) {
        // chunk 是 Uint8Array ，通过 TextDecoder 转换为字符串
        // console.log('chunk', chunk)
        const text = textDecoder.decode(chunk);
        if (text === "[DONE]") {
          console.log("done");
          return;
        }
        // 解析 chunk:
				// 	data: {"content":"你好"}\n\n
				//  data: {"content":"世界"}\n\n

				// chunk 有可能不是一个完整的 sse 消息, 要兼容这种情况：
				//  data: {"cont"
				//  "ent":"你好"}\n\n

				// 当chunk的内容包含 \n 时，这种情况其实无法满足 sse 格式规范，并不需要进行处理
        console.log('text', text)
      }
    //   const reader = response.body.getReader();
    //   while (true) {
    //     const { done, value } = await reader.read();
    //     if (done) {
    //       break;
    //     }
    //     const text = textDecoder.decode(value);
    //     if (text === "[DONE]") {
    //       console.log("done");
    //       return;
    //     }
    //     console.log('text', text)
    //   }

    });
    stop.addEventListener("click", function () {
      controller.abort();
    });
  </script>
</html>
